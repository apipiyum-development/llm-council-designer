# Многоступенчатый Dockerfile для LLM Council Backend
# Только бэкенд-сервер FastAPI

# Stage 1: Сборка фронтенда
FROM node:18-alpine AS frontend-builder

WORKDIR /app

# Копируем файлы зависимостей
COPY package*.json ./
RUN npm install

# Копируем исходный код фронтенда
COPY . .

# Собираем фронтенд
RUN npm run build

# Stage 2: Установка бэкенда
FROM python:3.11-alpine AS backend

WORKDIR /app

# Установка системных зависимостей
RUN apk add --no-cache gcc musl-dev

# Установка зависимостей Python
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Копируем исходный код бэкенда
COPY . .

# Копируем собранный фронтенд из предыдущего этапа
COPY --from=frontend-builder /app/dist /app/dist

# Финальный образ
FROM python:3.11-alpine AS production

WORKDIR /app

# Установка системных зависимостей
RUN apk add --no-cache gcc musl-dev

# Установка зависимостей Python
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Копируем исходный код бэкенда
COPY . .

# Копируем собранный фронтенд из предыдущего этапа
COPY --from=backend /app/dist /app/dist

EXPOSE 8000

# Запуск uvicorn
CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]